<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TDS Data Analyst Agent</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --accent: #6366f1;
        --accent-hover: #4f46e5;
        --error: #ef4444;
        --success: #22c55e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.5;
        display: flex;
        flex-direction: column;
      }

      .container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1.5rem;
      }

      .header {
        text-align: center;
        margin-bottom: 2.5rem;
        padding: 2rem 0;
        border-bottom: 1px solid var(--bg-tertiary);
      }

      .header h1 {
        font-size: 2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        letter-spacing: -0.025em;
      }

      .header p {
        color: var(--text-secondary);
        font-size: 1.125rem;
      }

      .main-card {
        background: var(--bg-secondary);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
      }

      .file-input {
        width: 100%;
        padding: 2rem;
        border: 2px dashed var(--bg-tertiary);
        border-radius: 0.75rem;
        background: var(--bg-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .file-input:hover {
        border-color: var(--accent);
        background: var(--bg-secondary);
      }

      .file-input input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      .file-input span {
        color: var(--text-secondary);
        font-size: 0.975rem;
        display: block;
      }

      .file-info {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: var(--bg-tertiary);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        display: none;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 1rem;
        margin-top: 2rem;
      }

      .btn {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.975rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: var(--accent-hover);
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }

      .btn-secondary:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem 0;
      }

      .spinner {
        border: 3px solid var(--bg-tertiary);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results {
        display: none;
        margin-top: 2rem;
      }

      .results h3 {
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .result-item {
        background: var(--bg-secondary);
        border-left: 4px solid var(--accent);
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 0 0.75rem 0.75rem 0;
        transition: transform 0.2s ease;
      }

      .result-item:hover {
        transform: translateX(4px);
      }

      .question {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        font-size: 1.1rem;
      }

      .answer {
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .answer pre {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        font-size: 0.875rem;
      }

      .answer img {
        max-width: 100%;
        border-radius: 0.75rem;
        margin: 1rem 0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }

      .answer img:hover {
        transform: scale(1.02);
      }

      .error {
        background: var(--bg-secondary);
        border-left: 4px solid var(--error);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        padding: 2rem;
      }

      .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 0.75rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .close {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        color: var(--text-primary);
        font-size: 2rem;
        font-weight: 300;
        cursor: pointer;
        padding: 0.5rem;
        line-height: 1;
      }

      .close:hover {
        color: var(--text-secondary);
      }

      footer {
        margin-top: auto;
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      footer strong {
        color: var(--accent);
        font-weight: 500;
      }

      @media (max-width: 640px) {
        .container {
          margin: 1rem auto;
          padding: 0 1rem;
        }

        .header {
          margin-bottom: 2rem;
          padding: 1.5rem 0;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .header p {
          font-size: 1rem;
        }

        .main-card {
          padding: 1.5rem;
        }

        .button-group {
          grid-template-columns: 1fr;
        }

        .file-input {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>TDS Data Analyst</h1>
        <p>Upload your questions and data for intelligent analysis</p>
      </div>

      <div class="main-card">
        <form id="analysisForm">
          <div class="form-group">
            <label for="questions_file"
              >Questions File (.txt)
              <span style="color: var(--error)">*</span></label
            >
            <div class="file-input" id="questionsDrop">
              <input
                type="file"
                id="questions_file"
                name="questions_file"
                accept=".txt"
              />
              <span>Drop your questions file here or click to browse</span>
            </div>
            <div id="questionsInfo" class="file-info"></div>
          </div>

          <div class="form-group">
            <label for="data_file">Dataset (Optional)</label>
            <div class="file-input" id="dataDrop">
              <input
                type="file"
                id="data_file"
                name="data_file"
                accept=".csv,.xlsx,.xls,.json,.parquet,.txt"
              />
              <span>Drop your dataset here or click to browse</span>
            </div>
            <div id="dataInfo" class="file-info"></div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <svg
                width="16"
                height="16"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
              Analyze Data
            </button>
            <button type="button" class="btn btn-secondary" id="clearBtn">
              <svg
                width="16"
                height="16"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
              Clear
            </button>
          </div>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Analyzing your data...</p>
        </div>

        <div class="results" id="results">
          <h3>
            <svg
              width="20"
              height="20"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            Analysis Results
          </h3>
          <div id="resultsContent"></div>
        </div>
      </div>

      <footer>
        <p>Created by <strong>VIVEK PAWAR</strong></p>
      </footer>
    </div>
    <!-- Image Modal -->
    <div id="imageModal" class="modal">
      <span class="close">&times;</span>
      <img class="modal-content" id="modalImage" alt="Visualization" />
    </div>

    <script>
      /* ---------- Image normalization helpers ---------- */
      function normalizeImageData(answer) {
        let s = null;
        if (typeof answer === "string") {
          s = answer.trim();
        } else if (answer && typeof answer === "object") {
          s =
            answer.image || answer.base64 || answer.plot || answer.data || null;
          if (typeof s === "string") s = s.trim();
        }
        if (!s) return null;

        s = s.replace(/^data:aimage\//i, "data:image/");

        if (/^data:image\//i.test(s)) return s;

        const base64Like =
          /^[A-Za-z0-9+/=\r\n]+$/.test(s) &&
          s.length > 200 &&
          !/\s{2,}/.test(s);
        if (base64Like) return "data:image/png;base64," + s;

        return null;
      }

      function renderAnswerInto(answer, container, onImageClick) {
        const maybeImg = normalizeImageData(answer);
        if (maybeImg) {
          const img = document.createElement("img");
          img.src = maybeImg;
          img.alt = "Generated visualization";
          img.addEventListener("click", () => onImageClick(maybeImg));
          container.appendChild(img);
          return;
        }
        const text =
          answer && typeof answer === "object"
            ? JSON.stringify(answer, null, 2)
            : String(answer ?? "");
        if (text.includes("\n") || text.length > 120) {
          const pre = document.createElement("pre");
          pre.style.whiteSpace = "pre-wrap";
          pre.style.background = "#f8f9fa";
          pre.style.padding = "15px";
          pre.style.borderRadius = "5px";
          pre.style.overflow = "auto";
          pre.textContent = text;
          container.appendChild(pre);
        } else {
          container.textContent = text;
        }
      }

      /* ---------------- App ---------------- */
      class DataAnalystApp {
        constructor() {
          this.form = document.getElementById("analysisForm");
          this.qFileInput = document.getElementById("questions_file");
          this.dFileInput = document.getElementById("data_file");
          this.qDrop = document.getElementById("questionsDrop");
          this.dDrop = document.getElementById("dataDrop");
          this.qInfo = document.getElementById("questionsInfo");
          this.dInfo = document.getElementById("dataInfo");
          this.submitBtn = document.getElementById("submitBtn");
          this.clearBtn = document.getElementById("clearBtn");
          this.loading = document.getElementById("loading");
          this.results = document.getElementById("results");
          this.resultsContent = document.getElementById("resultsContent");
          this.modal = document.getElementById("imageModal");
          this.modalImage = document.getElementById("modalImage");
          this.closeModal = document.querySelector(".close");
          this.initEventListeners();
        }

        initEventListeners() {
          this.form.addEventListener("submit", (e) => this.handleSubmit(e));
          this.clearBtn.addEventListener("click", () => this.clearForm());
          this.qFileInput.addEventListener("change", (e) =>
            this.handleFileSelect(e, "q")
          );
          this.dFileInput.addEventListener("change", (e) =>
            this.handleFileSelect(e, "d")
          );
          this.closeModal.addEventListener("click", () =>
            this.hideImageModal()
          );
          this.modal.addEventListener("click", (e) => {
            if (e.target === this.modal) this.hideImageModal();
          });
          this.setupDrop(this.dDrop, (files) => {
            if (files && files.length > 0) {
              this.dFileInput.files = files;
              this.handleFileSelect({ target: { files } }, "d");
            }
          });
          this.setupDrop(this.qDrop, (files) => {
            if (files && files.length > 0) {
              this.qFileInput.files = files;
              this.handleFileSelect({ target: { files } }, "q");
            }
          });
        }

        setupDrop(zone, onDropFiles) {
          zone.addEventListener("dragover", (e) => {
            e.preventDefault();
            zone.style.borderColor = "#667eea";
          });
          zone.addEventListener("dragleave", (e) => {
            e.preventDefault();
            zone.style.borderColor = "#e1e5e9";
          });
          zone.addEventListener("drop", (e) => {
            e.preventDefault();
            zone.style.borderColor = "#e1e5e9";
            onDropFiles(e.dataTransfer.files);
          });
        }

        handleFileSelect(event, type) {
          const file = event.target.files[0];
          if (type === "q") {
            if (file) {
              this.qInfo.innerHTML = `<strong>Questions:</strong> ${
                file.name
              } (${(file.size / 1024).toFixed(2)} KB)`;
              this.qInfo.style.display = "block";
            } else {
              this.qInfo.style.display = "none";
            }
          } else {
            if (file) {
              this.dInfo.innerHTML = `<strong>Dataset:</strong> ${
                file.name
              } (${(file.size / 1024).toFixed(2)} KB)`;
              this.dInfo.style.display = "block";
            } else {
              this.dInfo.style.display = "none";
            }
          }
        }

        async handleSubmit(event) {
          event.preventDefault();
          if (!this.qFileInput.files[0]) {
            alert("Please upload your questions .txt file.");
            return;
          }
          this.showLoading();
          this.hideResults();

          try {
            const formData = new FormData();
            formData.append("questions_file", this.qFileInput.files[0]);
            if (this.dFileInput.files[0])
              formData.append("data_file", this.dFileInput.files[0]);

            const response = await fetch("/api", {
              method: "POST",
              body: formData,
            }); // changed endpoint

            if (!response.ok) {
              let msg = `HTTP ${response.status}`;
              try {
                const err = await response.json();
                if (err && err.detail) msg = err.detail;
              } catch {}
              throw new Error(msg);
            }

            const data = await response.json();
            this.displayResults(data);
          } catch (err) {
            console.error("Analysis failed:", err);
            this.displayError(err.message || "Unknown error");
          } finally {
            this.hideLoading();
          }
        }

        displayResults(data) {
          this.resultsContent.innerHTML = "";
          if (data.error) {
            this.displayError(data.error);
            return;
          }
          Object.entries(data).forEach(([question, answer]) => {
            const item = document.createElement("div");
            item.className = "result-item";
            const qDiv = document.createElement("div");
            qDiv.className = "question";
            qDiv.textContent = question;
            const aDiv = document.createElement("div");
            aDiv.className = "answer";
            renderAnswerInto(answer, aDiv, (src) => this.showImageModal(src));
            item.appendChild(qDiv);
            item.appendChild(aDiv);
            this.resultsContent.appendChild(item);
          });
          this.showResults();
          this.scrollToResults();
        }

        displayError(message) {
          this.resultsContent.innerHTML = "";
          const item = document.createElement("div");
          item.className = "result-item error";
          const title = document.createElement("div");
          title.className = "question";
          title.textContent = "❌ Error";
          const content = document.createElement("div");
          content.className = "answer";
          content.textContent = message;
          item.appendChild(title);
          item.appendChild(content);
          this.resultsContent.appendChild(item);
          this.showResults();
          this.scrollToResults();
        }

        showImageModal(src) {
          this.modalImage.src = src;
          this.modal.style.display = "block";
          document.body.style.overflow = "hidden";
        }
        hideImageModal() {
          this.modal.style.display = "none";
          document.body.style.overflow = "auto";
        }
        showLoading() {
          this.loading.style.display = "block";
          this.submitBtn.disabled = true;
          this.submitBtn.textContent = "⏳ Analyzing...";
        }
        hideLoading() {
          this.loading.style.display = "none";
          this.submitBtn.disabled = false;
          this.submitBtn.textContent = "🚀 Analyze Data";
        }
        showResults() {
          this.results.style.display = "block";
        }
        hideResults() {
          this.results.style.display = "none";
        }
        scrollToResults() {
          setTimeout(
            () =>
              this.results.scrollIntoView({
                behavior: "smooth",
                block: "start",
              }),
            100
          );
        }
        clearForm() {
          this.qFileInput.value = "";
          this.dFileInput.value = "";
          this.qInfo.style.display = "none";
          this.dInfo.style.display = "none";
          this.hideResults();
          this.hideLoading();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new DataAnalystApp();
      });
    </script>
  </body>
</html>
